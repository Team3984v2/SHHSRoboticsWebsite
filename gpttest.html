<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhreakyGPT</title>
    <style>
    #chatbot-overlay {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 300px;
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 10px; /* Rounded edges */
        background: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        opacity: 1; /* Initial opacity */
        transition: opacity 0.3s ease, transform 0.3s ease; /* Smooth animations */
        transform: translateY(0); /* Initial position */
    }

    #chatbot-overlay.hidden {
        opacity: 0; /* Hide with fade-out */
        transform: translateY(100%); /* Move out of view */
    }

    #chatbot-header {
        background: #aae5a4;
        color: #000;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
    }

    #chatbot-close {
        background: none;
        border: none;
        color: #000;
        font-size: 20px;
        cursor: pointer;
    }

    #chatbot-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        border-bottom: 1px solid #ccc;
    }

    #chatbot-input {
        border: none;
        border-top: 1px solid #ccc;
        padding: 10px;
        width: calc(100% - 90px);
        box-sizing: border-box;
    }

    #chatbot-send {
        border: none;
        background: #aae5a4;
        color: #000;
        padding: 10px;
        cursor: pointer;
    }

    .message {
        margin-bottom: 10px;
        white-space: pre-wrap; /* Preserve whitespace and line breaks */
    }

    #thought-bubble {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: url('./phreakygpt.png') no-repeat center center;
        background-size: contain;
        cursor: pointer;
        display: none; /* Hidden by default */
        transition: opacity 0.3s ease;
    }
    </style>
</head>
<body>
    <div id="chatbot-overlay">
        <div id="chatbot-header">
            <span>PhreakyGPT</span>
            <button id="chatbot-close">Ã—</button>
        </div>
        <div id="chatbot-messages"></div>
        <input type="text" id="chatbot-input" placeholder="Type your message...">
        <button id="chatbot-send">Send</button>
    </div>
    <div id="thought-bubble"></div>
    <script>
        const apiUrl = 'https://http://desktop-hc7vivj.tail9878d2.ts.net:443/v1/chat/completions'; // OpenAI API endpoint

        const systemMessage = `
        <<SYS>>
        You are a helpful, respectful, and honest assistant. Always answer as helpfully as possible, while being safe. 
        Your answers should not include any harmful, unethical, racist, sexist, toxic, dangerous, or illegal content. 
        Please ensure that your responses are socially unbiased and positive in nature. 
        If a question does not make any sense, or is not factually coherent, explain why instead of answering something incorrect. 
        If you don't know the answer to a question, please don't share false information. Never include <|im_end|> or <|im_start|> in your responses.
        <</SYS>>`;
/*Always answer as helpfully as possible, while being safe. 
        Your answers should not include any harmful, unethical, racist, sexist, toxic, dangerous, or illegal content. 
        Please ensure that your responses are socially unbiased and positive in nature. 
        If a question does not make any sense, or is not factually coherent, explain why instead of answering something incorrect. 
        If you don't know the answer to a question, please don't share false information.*/
        let conversationHistory = `system\n${systemMessage}\n`; // Initial system message
        let abortController = new AbortController(); // Initialize AbortController

        document.getElementById('chatbot-send').addEventListener('click', sendMessage);
        document.getElementById('chatbot-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        document.getElementById('chatbot-close').addEventListener('click', () => {
            terminateChat(); // Call terminateChat when closing the chat box
        });

        document.getElementById('thought-bubble').addEventListener('click', () => {
            const overlay = document.getElementById('chatbot-overlay');
            const bubble = document.getElementById('thought-bubble');
            overlay.style.display = 'flex'; // Show chat box
            setTimeout(() => {
                overlay.classList.remove('hidden');
            }, 10);
            bubble.style.display = 'none'; // Hide thought bubble
        });

        async function sendMessage() {
            const inputElement = document.getElementById('chatbot-input');
            const userMessage = inputElement.value.trim();
            if (userMessage === '') return;

            appendMessage('You', userMessage);
            conversationHistory += `user\n${userMessage}\n`; // Append user message to history
            inputElement.value = '';

            let botMessage = '';
            let botMessageElement = appendMessage('Bot', ''); // Create an empty message element to update as text is received

            const promptTemplate = `[INST] ${systemMessage} {${userMessage}} [/INST]`;

            abortController = new AbortController(); // Reinitialize AbortController for each new request

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        //'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo", // You can use "gpt-4" if available in your OpenAI account
                        messages: [
                            { role: "system", content: systemMessage },
                            { role: "user", content: userMessage }
                        ],
                        stream: true
                    }),
                    signal: abortController.signal // Pass the abort signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let done = false;

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    const chunk = decoder.decode(value, { stream: !done });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr === '[DONE]') {
                                done = true;
                                break;
                            }

                            try {
                                const parsedData = JSON.parse(jsonStr);
                                if (parsedData.choices && parsedData.choices[0].delta.content) {
                                    const deltaContent = parsedData.choices[0].delta.content;
                                    if (deltaContent) { // Only append if deltaContent is not empty
                                        botMessage += deltaContent; // Append content without extra spaces
                                        botMessageElement.innerHTML = botMessage; // Update the message as new content is received
                                    }
                                }
                            } catch (e) {
                                console.error('Could not parse JSON:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Fetch request was aborted.');
                } else {
                    console.error('Error:', error);
                    botMessageElement.innerHTML = 'Sorry, something went wrong.';
                }
            }
        }

        function appendMessage(sender, message) {
            const messagesElement = document.getElementById('chatbot-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `<strong>${sender}:</strong> <p>${message}</p>`;
            messagesElement.appendChild(messageElement);
            messagesElement.scrollTop = messagesElement.scrollHeight;
            return messageElement.querySelector('p'); // Return the paragraph element for live updates
        }

        function terminateChat() {
            const overlay = document.getElementById('chatbot-overlay');
            const bubble = document.getElementById('thought-bubble');
            overlay.classList.add('hidden');
            bubble.style.display = 'block'; // Show thought bubble
            abortController.abort(); // Abort any ongoing fetch requests
            conversationHistory = ''; // Clear conversation history
        }

        // Optional: Automatically show the chatbot when the page loads
        window.onload = function() {
            document.getElementById('chatbot-overlay').style.display = 'flex'; // Ensure the chat box is visible on page load
        };
    </script>
</body>
</html>
